<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Diagnostic Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .diagnostic-panel {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        .test-item.success {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        .test-item.error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .test-item.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-result {
            font-family: monospace;
            font-size: 14px;
            color: #666;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #45a049;
        }
        .solution {
            background: #fff9c4;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #fbc02d;
        }
        .solution h3 {
            margin-top: 0;
            color: #f57f17;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="diagnostic-panel">
        <h1>üî• Firebase Diagnostic Tool</h1>
        <p>This tool will help diagnose why Firebase is not saving data.</p>

        <button onclick="runDiagnostics()">Run Diagnostics</button>
        <button onclick="testWrite()">Test Write to Firebase</button>

        <div id="results"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, set, get, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB29CbGcIQRuMnnMe2C8RT4Qkt5G7Y_L9Q",
            authDomain: "student-scoring-system-1aa10.firebaseapp.com",
            databaseURL: "https://student-scoring-system-1aa10-default-rtdb.firebaseio.com",
            projectId: "student-scoring-system-1aa10",
            storageBucket: "student-scoring-system-1aa10.firebasestorage.app",
            messagingSenderId: "26728761382",
            appId: "1:26728761382:web:a378c1f2714794a8627ee7",
            measurementId: "G-J0HGKX47G7"
        };

        let app, database, auth;
        let diagnosticResults = [];

        function addResult(name, status, message, solution = null) {
            diagnosticResults.push({ name, status, message, solution });
            displayResults();
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = diagnosticResults.map(result => `
                <div class="test-item ${result.status}">
                    <div class="test-name">${result.name}</div>
                    <div class="test-result">${result.message}</div>
                    ${result.solution ? `<div class="solution">${result.solution}</div>` : ''}
                </div>
            `).join('');
        }

        window.runDiagnostics = async function() {
            diagnosticResults = [];
            addResult('Starting diagnostics...', 'warning', 'Running all tests...');

            // Test 1: Firebase Initialization
            try {
                app = initializeApp(firebaseConfig);
                addResult('‚úÖ Firebase App Initialization', 'success', 'Firebase app initialized successfully');
            } catch (error) {
                addResult('‚ùå Firebase App Initialization', 'error',
                    `Failed: ${error.message}`,
                    '<h3>Solution:</h3><p>Check your Firebase configuration in firebase-config.js</p>');
                return;
            }

            // Test 2: Database Connection
            try {
                database = getDatabase(app);
                addResult('‚úÖ Database Connection', 'success', `Connected to: ${firebaseConfig.databaseURL}`);
            } catch (error) {
                addResult('‚ùå Database Connection', 'error', `Failed: ${error.message}`);
                return;
            }

            // Test 3: Auth Initialization
            try {
                auth = getAuth(app);
                addResult('‚úÖ Auth Initialization', 'success', 'Auth service initialized');
            } catch (error) {
                addResult('‚ùå Auth Initialization', 'error', `Failed: ${error.message}`);
                return;
            }

            // Test 4: Anonymous Sign In
            try {
                const userCredential = await signInAnonymously(auth);
                addResult('‚úÖ Anonymous Authentication', 'success',
                    `Signed in successfully. UID: ${userCredential.user.uid}`);
            } catch (error) {
                const solution = error.code === 'auth/operation-not-allowed' ?
                    `<h3>üö® CRITICAL ISSUE FOUND!</h3>
                    <p><strong>Anonymous Authentication is NOT enabled in Firebase Console.</strong></p>
                    <h3>How to fix:</h3>
                    <ol>
                        <li>Go to <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/providers" target="_blank">Firebase Console - Authentication</a></li>
                        <li>Click on "Sign-in method" tab</li>
                        <li>Find "Anonymous" in the list</li>
                        <li>Click on it and toggle "Enable" to ON</li>
                        <li>Click "Save"</li>
                        <li>Refresh this page and run diagnostics again</li>
                    </ol>` :
                    `<h3>Solution:</h3><p>Auth error: ${error.message}</p>`;

                addResult('‚ùå Anonymous Authentication', 'error',
                    `Failed: ${error.code} - ${error.message}`, solution);
                return;
            }

            // Test 5: Test Read Permission
            try {
                const testRef = ref(database, 'students');
                const snapshot = await get(testRef);
                addResult('‚úÖ Read Permission', 'success',
                    `Can read from database. Found ${snapshot.exists() ? Object.keys(snapshot.val()).length : 0} students`);
            } catch (error) {
                addResult('‚ùå Read Permission', 'error',
                    `Failed: ${error.code} - ${error.message}`,
                    `<h3>Solution:</h3><p>Check your Firebase Database Rules. They should allow authenticated users to read.</p>
                    <pre>{
  "rules": {
    "students": {
      ".read": "auth != null",
      ".write": "auth != null"
    }
  }
}</pre>`);
            }

            addResult('‚úÖ All Tests Complete', 'success',
                'Diagnostics complete. Use the "Test Write" button to verify write permissions.');
        };

        window.testWrite = async function() {
            if (!auth || !auth.currentUser) {
                alert('Please run diagnostics first!');
                return;
            }

            const testStudentId = 'TEST_STUDENT_' + Date.now();
            const testData = {
                name: 'Test Student',
                scores: { behavior: 10 },
                scans: { behavior: new Date().toISOString().split('T')[0] },
                lastUpdated: serverTimestamp(),
                lastUpdatedBy: 'Diagnostic Tool'
            };

            try {
                const studentRef = ref(database, `students/${testStudentId}`);
                await set(studentRef, testData);

                addResult('‚úÖ Write Test', 'success',
                    `Successfully wrote test data to Firebase!<br>Student ID: ${testStudentId}<br>
                    <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/database/${firebaseConfig.projectId}-default-rtdb/data/~2Fstudents~2F${testStudentId}" target="_blank">View in Firebase Console</a>`);

                // Verify the write
                const snapshot = await get(studentRef);
                if (snapshot.exists()) {
                    addResult('‚úÖ Write Verification', 'success',
                        `Data verified in Firebase:<br><pre>${JSON.stringify(snapshot.val(), null, 2)}</pre>`);
                }
            } catch (error) {
                const solution = error.code === 'PERMISSION_DENIED' ?
                    `<h3>üö® PERMISSION DENIED!</h3>
                    <p>Your Firebase Database Rules are blocking writes.</p>
                    <h3>How to fix:</h3>
                    <ol>
                        <li>Go to <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/database/${firebaseConfig.projectId}-default-rtdb/rules" target="_blank">Firebase Console - Database Rules</a></li>
                        <li>Replace the rules with:</li>
                    </ol>
                    <pre>{
  "rules": {
    "students": {
      ".read": "auth != null",
      ".write": "auth != null"
    },
    "admins": {
      ".read": "auth != null",
      ".write": "auth != null"
    },
    "scoreTypes": {
      ".read": "auth != null",
      ".write": "auth != null"
    }
  }
}</pre>
                    <p>Then click "Publish"</p>` :
                    `<h3>Solution:</h3><p>Error: ${error.message}</p>`;

                addResult('‚ùå Write Test', 'error',
                    `Failed: ${error.code} - ${error.message}`, solution);
            }
        };

        // Auto-run diagnostics on load
        setTimeout(() => runDiagnostics(), 500);
    </script>
</body>
</html>
